<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HORÁRIO - Lista de Empresas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* [Seus estilos CSS existentes permanecem os mesmos] */
    </style>
</head>
<body>
    <!-- [Seu HTML existente permanece o mesmo até a seção de empresas] -->
    
    <script>
        // Variáveis globais
        let todasEmpresas = [];
        let servicosDisponiveis = new Set();

        // Função para formatar telefone
        function formatarTelefone(numero) {
            if (!numero) return '';
            
            const digits = numero.replace(/\D/g, '');
            
            if (digits.length === 11) {
                return `(${digits.substring(0, 2)}) ${digits.substring(2, 7)}-${digits.substring(7)}`;
            } else if (digits.length === 10) {
                return `(${digits.substring(0, 2)}) ${digits.substring(2, 6)}-${digits.substring(6)}`;
            }
            
            return numero;
        }

        // Função para exibir empresas
        function exibirEmpresas(empresas) {
            const listaEmpresas = document.getElementById('empresas-lista');
            
            if (empresas.length === 0) {
                listaEmpresas.innerHTML = '<div class="error-message">Nenhuma empresa encontrada com os filtros selecionados.</div>';
                return;
            }
            
            listaEmpresas.innerHTML = '<div class="empresas-grid" id="empresas-grid"></div>';
            const gridEmpresas = document.getElementById('empresas-grid');
            
            empresas.forEach(empresa => {
                const empresaElement = document.createElement('div');
                empresaElement.className = 'empresa-item';
                
                const telefoneFormatado = formatarTelefone(empresa.telefone || empresa.telefoneComercial || '');
                const enderecoCompleto = [
                    empresa.endereco,
                    empresa.numero,
                    empresa.complemento,
                    empresa.bairro
                ].filter(Boolean).join(', ');
                
                empresaElement.innerHTML = `
                    <div class="empresa-nome">${empresa.nome || empresa.nomeEmpresa || 'Nome não informado'}</div>
                    <div class="servico-tag">${empresa.servico || empresa.tipoServico || 'Serviço não especificado'}</div>
                    <div class="empresa-info">
                        ${enderecoCompleto || 'Endereço não informado'}<br>
                        ${empresa.cidade || ''}${empresa.estado ? ' - ' + empresa.estado : ''}
                    </div>
                    ${telefoneFormatado ? `<div class="empresa-contato"><i class="fas fa-phone"></i> ${telefoneFormatado}</div>` : ''}
                    <div class="divider"></div>
                `;
                
                gridEmpresas.appendChild(empresaElement);
            });
        }

        // Função para filtrar empresas
        function filtrarEmpresas() {
            const servico = document.getElementById('servico').value;
            const nomeEmpresa = document.getElementById('nome-empresa').value.toLowerCase();
            
            const empresasFiltradas = todasEmpresas.filter(empresa => {
                const nome = (empresa.nome || empresa.nomeEmpresa || '').toLowerCase();
                const servicoEmpresa = (empresa.servico || empresa.tipoServico || '').toLowerCase();
                
                return (!servico || servicoEmpresa.includes(servico.toLowerCase())) &&
                       (!nomeEmpresa || nome.includes(nomeEmpresa));
            });
            
            exibirEmpresas(empresasFiltradas);
        }

        // Função para carregar empresas da API
        async function carregarEmpresas() {
            try {
                const listaEmpresas = document.getElementById('empresas-lista');
                listaEmpresas.innerHTML = '<div class="loading"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p>Carregando empresas...</p></div>';
                
                // Faz a requisição para a URL do blob
                const response = await fetch('blob:https://brunohpsv.github.io/5912f332-f19f-4f06-962d-108c8fcc3e6e');
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar dados das empresas');
                }
                
                const data = await response.json();
                
                // Processa os dados recebidos
                todasEmpresas = Array.isArray(data) ? data : [];
                if (!Array.isArray(data) && data.empresas) {
                    todasEmpresas = data.empresas; // Corrigindo typo no nome da propriedade
                }
                
                servicosDisponiveis = new Set();
                
                // Coleta todos os serviços disponíveis
                todasEmpresas.forEach(empresa => {
                    if (empresa.servico || empresa.tipoServico) {
                        servicosDisponiveis.add(empresa.servico || empresa.tipoServico);
                    }
                });
                
                // Atualiza filtro de serviços
                const selectServico = document.getElementById('servico');
                selectServico.innerHTML = '<option value="">Todos os serviços</option>';
                Array.from(servicosDisponiveis).sort().forEach(servico => {
                    const option = document.createElement('option');
                    option.value = servico;
                    option.textContent = servico;
                    selectServico.appendChild(option);
                });
                
                // Exibe todas as empresas inicialmente
                exibirEmpresas(todasEmpresas);
                
                // Configura listeners para os filtros
                document.getElementById('servico').addEventListener('change', filtrarEmpresas);
                document.getElementById('nome-empresa').addEventListener('input', filtrarEmpresas);
                
            } catch (error) {
                console.error('Erro ao carregar empresas:', error);
                document.getElementById('empresas-lista').innerHTML = `
                    <div class="error-message">
                        Ocorreu um erro ao carregar as empresas. Por favor, recarregue a página.
                        <br><small>${error.message}</small>
                    </div>
                `;
                
                // Tenta carregar dados de fallback caso a URL do blob não funcione
                try {
                    const fallbackResponse = await fetch('https://brunohpsv.github.io/dados/');
                    if (fallbackResponse.ok) {
                        const fallbackData = await fallbackResponse.json();
                        todasEmpresas = Array.isArray(fallbackData) ? fallbackData : [];
                        exibirEmpresas(todasEmpresas);
                    }
                } catch (fallbackError) {
                    console.error('Erro ao carregar fallback:', fallbackError);
                }
            }
        }

        // Inicia quando a página carrega
        document.addEventListener('DOMContentLoaded', carregarEmpresas);
    </script>
</body>
</html>
