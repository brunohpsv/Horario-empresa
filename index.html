<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HORÁRIO - Lista de Empresas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* (Mantenha todos os estilos CSS anteriores) */
    </style>
</head>
<body>
    <!-- (Mantenha toda a estrutura HTML anterior) -->

    <script>
        // URL da página de dados
        const DATA_URL = "data.html";  // Alterado para caminho relativo
        
        // Variáveis globais
        let todasEmpresas = [];
        let estadosDisponiveis = new Set();
        let servicosDisponiveis = new Set();

        // Função para formatar texto (mantida igual)
        function formatarTexto(texto) {
            if (!texto) return '';
            const siglasEstados = ['ac', 'al', 'ap', 'am', 'ba', 'ce', 'df', 'es', 'go', 
                                  'ma', 'mt', 'ms', 'mg', 'pa', 'pb', 'pr', 'pe', 'pi', 
                                  'rj', 'rn', 'rs', 'ro', 'rr', 'sc', 'sp', 'se', 'to'];
            if (siglasEstados.includes(texto.toLowerCase())) {
                return texto.toUpperCase();
            }
            return texto.toLowerCase()
                .split(' ')
                .map(palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1))
                .join(' ');
        }

        // Nova função para buscar dados via fetch
        async function buscarDadosEmpresas() {
            try {
                document.getElementById('empresas-lista').innerHTML = '<div class="loading">Carregando empresas...</div>';
                
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error("Falha na requisição");
                
                const data = await response.json();
                processarDadosEmpresas(data.data);
                
            } catch (error) {
                console.error("Erro ao buscar dados:", error);
                mostrarErro("Erro ao carregar dados. Tente recarregar a página.");
            }
        }

        // Função processarDadosEmpresas (mantida igual)
        function processarDadosEmpresas(firebaseData) {
            try {
                todasEmpresas = [];
                estadosDisponiveis = new Set();
                servicosDisponiveis = new Set();
                
                const usuarios = firebaseData.usuarios || [];
                
                usuarios.forEach(empresa => {
                    if (empresa.data.nomeFantasia && empresa.data.status !== 'pendente') {
                        const empresaFormatada = {
                            id: empresa.id,
                            nome: formatarTexto(empresa.data.nomeFantasia) || 'Nome não informado',
                            cidade: formatarTexto(empresa.data.cidade) || 'Cidade não informada',
                            estado: formatarTexto(empresa.data.estado) || 'Estado não informado',
                            servico: formatarTexto(empresa.data.servicos || empresa.data.servico || 'Serviço não informado'),
                            telefone: empresa.data.telefone || '',
                            endereco: empresa.data.endereco ? 
                                `${formatarTexto(empresa.data.endereco)}${empresa.data.numero ? ', ' + empresa.data.numero : ''}` : '',
                            bairro: formatarTexto(empresa.data.bairro) || ''
                        };
                        
                        todasEmpresas.push(empresaFormatada);
                        estadosDisponiveis.add(empresaFormatada.estado);
                        servicosDisponiveis.add(empresaFormatada.servico);
                    }
                });
                
                atualizarFiltros();
                exibirEmpresas(todasEmpresas);
                
            } catch (error) {
                console.error("Erro ao processar dados:", error);
                mostrarErro("Erro ao processar dados recebidos.");
            }
        }

        // Funções auxiliares (mantidas iguais)
        function atualizarFiltros() {
            /* (implementação igual) */
        }

        function atualizarCidades(estadoSelecionado) {
            /* (implementação igual) */
        }

        function filtrarEmpresas() {
            /* (implementação igual) */
        }

        function exibirEmpresas(empresas) {
            /* (implementação igual) */
        }

        function mostrarErro(mensagem) {
            /* (implementação igual) */
        }

        // Quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Carrega os dados imediatamente
            buscarDadosEmpresas();
            
            // Configura listeners para os filtros
            document.getElementById('estado').addEventListener('change', function() {
                atualizarCidades(this.value);
                filtrarEmpresas();
            });
            
            document.getElementById('cidade').addEventListener('change', filtrarEmpresas);
            document.getElementById('servico').addEventListener('change', filtrarEmpresas);
            document.getElementById('nome-empresa').addEventListener('input', filtrarEmpresas);
        });
    </script>
</body>
</html>
