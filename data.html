<!DOCTYPE html>
<html>
<head>
    <title>API de Dados Firestore</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyClmS9QnPH_HpLzN8mGW2s2PjfH4HXEAt8",
            authDomain: "horariosite-669d1.firebaseapp.com",
            projectId: "horariosite-669d1"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Cache de dados
        let cachedData = {
            usuarios: [],
            lastUpdated: null
        };

        // Função para carregar todos os dados
        async function loadAllData() {
            try {
                console.log("Iniciando atualização de dados...");
                
                // Carrega apenas a coleção 'usuarios' que é necessária para o index.html
                const snapshot = await db.collection("usuarios").get();
                const usuarios = snapshot.docs.map(doc => ({
                    id: doc.id,
                    data: doc.data()
                }));

                // Atualiza o cache
                cachedData = {
                    usuarios,
                    lastUpdated: new Date().toISOString()
                };
                
                console.log("Dados atualizados com sucesso em:", cachedData.lastUpdated);
                
            } catch (error) {
                console.error("Erro ao atualizar dados:", error);
            }
        }

        // Atualiza os dados imediatamente e a cada 5 segundos
        loadAllData().catch(console.error);
        setInterval(() => loadAllData().catch(console.error), 5000);

        // Função para retornar os dados formatados
        function getFormattedData() {
            return {
                status: "success",
                lastUpdated: cachedData.lastUpdated,
                data: {
                    usuarios: cachedData.usuarios
                }
            };
        }

        // Função para lidar com mensagens de outros frames
        window.addEventListener('message', function(event) {
            // Verifica se a mensagem é uma solicitação de dados
            if (event.data && event.data.type === 'REQUEST_FIREBASE_DATA') {
                // Envia os dados de volta
                event.source.postMessage({
                    type: 'FIREBASE_DATA_RESPONSE',
                    data: getFormattedData()
                }, event.origin);
            }
        });

        // Se acessado diretamente, retorna os dados em JSON
        if (window === window.top) {
            document.write(JSON.stringify(getFormattedData()));
            document.close();
        }
    </script>
</head>
<body>
    <!-- Conteúdo apenas para visualização direta -->
    <h1>API de Dados Firestore</h1>
    <p>Esta página serve como endpoint para os dados.</p>
    <p>Última atualização: <span id="last-update">${cachedData.lastUpdated || 'N/A'}</span></p>
    <p>Status: <span id="status">Carregando...</span></p>
    
    <script>
        // Atualiza o status periodicamente
        setInterval(() => {
            document.getElementById('last-update').textContent = cachedData.lastUpdated || 'N/A';
            document.getElementById('status').textContent = cachedData.lastUpdated ? 'Ativo' : 'Carregando...';
        }, 1000);
    </script>
</body>
</html>
