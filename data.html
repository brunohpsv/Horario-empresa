<!DOCTYPE html>
<html>
<head>
    <title>API de Dados Firestore</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyClmS9QnPH_HpLzN8mGW2s2PjfH4HXEAt8",
            authDomain: "horariosite-669d1.firebaseapp.com",
            projectId: "horariosite-669d1"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Cache de dados
        let cachedData = {
            usuarios: [],
            horarios: [],
            turmas: [],
            aulas: [],
            professores: [],
            lastUpdated: null
        };

        // Função para carregar todos os dados
        async function loadAllData() {
            try {
                console.log("Iniciando atualização de dados...");
                
                const collections = ["usuarios", "horarios", "turmas", "aulas", "professores"];
                const newData = {};
                
                // Carrega todas as coleções em paralelo
                await Promise.all(collections.map(async (collectionName) => {
                    try {
                        const snapshot = await db.collection(collectionName).get();
                        newData[collectionName] = snapshot.docs.map(doc => ({
                            id: doc.id,
                            data: doc.data()
                        }));
                    } catch (error) {
                        console.error(`Erro na coleção ${collectionName}:`, error);
                        newData[collectionName] = [];
                    }
                }));

                // Atualiza o cache
                cachedData = {
                    ...newData,
                    lastUpdated: new Date().toISOString()
                };
                
                console.log("Dados atualizados com sucesso em:", cachedData.lastUpdated);
                
            } catch (error) {
                console.error("Erro geral ao atualizar dados:", error);
            }
        }

        // Atualiza os dados imediatamente e a cada 5 segundos
        loadAllData().catch(console.error);
        setInterval(() => loadAllData().catch(console.error), 5000);

        // Função para retornar os dados formatados
        function getFormattedData() {
            return {
                status: "success",
                lastUpdated: cachedData.lastUpdated,
                data: {
                    usuarios: cachedData.usuarios,
                    horarios: cachedData.horarios,
                    turmas: cachedData.turmas,
                    aulas: cachedData.aulas,
                    professores: cachedData.professores
                }
            };
        }
    </script>
</head>
<body>
    <script>
        // Configura o cabeçalho para retornar JSON
        document.write(`
            <script>
                // Verifica se é uma requisição fetch
                if (window.parent !== window) {
                    const data = getFormattedData();
                    const jsonData = JSON.stringify(data);
                    
                    // Envia os dados para o parent
                    parent.postMessage({
                        type: 'FIREBASE_DATA',
                        data: data
                    }, '*');
                    
                    // Escreve o JSON diretamente no documento
                    document.write(jsonData);
                    document.close();
                } else {
                    // Modo de visualização direta (para debug)
                    document.body.innerHTML = '<h1>API de Dados Firestore</h1>' +
                        '<p>Esta página serve como endpoint para os dados.</p>' +
                        '<p>Última atualização: <span id="last-update">${cachedData.lastUpdated || 'N/A'}</span></p>' +
                        '<p>Status: <span id="status">Carregando...</span></p>';
                    
                    // Atualiza o status periodicamente
                    setInterval(() => {
                        document.getElementById('last-update').textContent = cachedData.lastUpdated || 'N/A';
                        document.getElementById('status').textContent = cachedData.lastUpdated ? 'Ativo' : 'Carregando...';
                    }, 1000);
                }
            </script>
        `);
    </script>
</body>
</html>
