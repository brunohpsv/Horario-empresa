<!DOCTYPE html>
<html>
<head>
    <title>API de Dados Firestore</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyClmS9QnPH_HpLzN8mGW2s2PjfH4HXEAt8",
            authDomain: "horariosite-669d1.firebaseapp.com",
            projectId: "horariosite-669d1"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Cache de dados
        let cachedData = {
            usuarios: [],
            lastUpdated: null
        };

        // Função para carregar todos os dados
        async function loadAllData() {
            try {
                console.log("Iniciando atualização de dados...");
                
                const snapshot = await db.collection("usuarios").get();
                const usuarios = snapshot.docs.map(doc => ({
                    id: doc.id,
                    data: doc.data()
                }));

                cachedData = {
                    usuarios,
                    lastUpdated: new Date().toISOString()
                };
                
                console.log("Dados atualizados com sucesso. Total:", usuarios.length);
                
            } catch (error) {
                console.error("Erro ao atualizar dados:", error);
                cachedData.lastUpdated = "Erro: " + new Date().toISOString();
            }
        }

        // Carrega os dados imediatamente
        loadAllData().catch(console.error);
        // Atualiza a cada 5 segundos
        setInterval(() => loadAllData().catch(console.error), 5000);

        function getFormattedData() {
            return {
                status: "success",
                lastUpdated: cachedData.lastUpdated,
                data: {
                    usuarios: cachedData.usuarios
                }
            };
        }

        // Função para lidar com mensagens
        window.addEventListener('message', function(event) {
            // Verifica a origem da mensagem
            if (event.origin !== "https://brunohpsv.github.io") return;
            
            if (event.data && event.data.type === 'REQUEST_FIREBASE_DATA') {
                console.log("Recebida solicitação de dados de:", event.origin);
                event.source.postMessage({
                    type: 'FIREBASE_DATA_RESPONSE',
                    data: getFormattedData()
                }, event.origin);
            }
        });

        // Se acessado diretamente
        if (window === window.top) {
            document.write(JSON.stringify(getFormattedData()));
            document.close();
        }
    </script>
</head>
<body>
    <!-- (Conteúdo mantido igual) -->
</body>
</html>
