<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Configurações | HORÁRIO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <style>
        /* Reset e estilos gerais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header */
        header {
            background-color: #000000;
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 30px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            transition: color 0.3s;
        }
        
        nav ul li a:hover {
            color: #cccccc;
        }
        
        .logout-btn {
            background-color: #f44336;
            padding: 8px 16px;
            border-radius: 4px;
        }
        
        .logout-btn:hover {
            background-color: #d32f2f;
        }
        
        /* Container principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            flex: 1;
            width: 100%;
        }
        
        /* Configurações */
        .configuracoes-form {
            background-color: white;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 100%;
        }
        
        .info-adicionais {
            background-color: #f9f9f9;
            padding: 30px;
            border-left: 4px solid #4CAF50;
            width: 100%;
        }
        
        .info-adicionais h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .info-item {
            margin-bottom: 15px;
        }
        
        .info-item strong {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        
        .info-contato {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 14px;
            color: #666;
        }
        
        /* Botões */
        .btn-cancelar {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .btn-cancelar:hover {
            background-color: #d32f2f;
        }
        
        /* Rodapé */
        footer {
            background-color: #000000;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 30px;
            width: 100%;
        }
        
        .contato-rodape {
            max-width: 1200px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .contato-rodape a {
            color: #4CAF50;
            text-decoration: none;
        }

        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Configuração de horários */
        .horarios-config {
            background-color: white;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .horarios-config h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        .dias-semana {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .dia-checkbox {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .dia-checkbox:hover {
            background: #e9e9e9;
        }

        .dia-checkbox input {
            margin-right: 8px;
        }

        .horarios-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .horario-input {
            flex: 1;
        }

        .btn-salvar {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .btn-salvar:hover {
            background-color: #45a049;
        }

        .horarios-exemplo {
            background-color: #f8f9fa;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            border-radius: 4px;
        }

        .horarios-exemplo h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .horarios-exemplo ul {
            list-style-type: none;
            padding-left: 0;
        }

        .horarios-exemplo li {
            margin-bottom: 5px;
        }

        .success-message {
            color: #4CAF50;
            margin-top: 10px;
            font-weight: bold;
            display: none;
        }
        
        /* Relatório */
        .relatorio-section {
            background-color: white;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-radius: 4px;
        }
        
        .relatorio-section h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .relatorio-info {
            background-color: #f8f9fa;
            padding: 20px;
            margin-top: 20px;
            border-radius: 4px;
        }
        
        /* Seção de almoço melhorada */
        .almoco-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .almoco-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .almoco-toggle input {
            margin-right: 10px;
        }
        
        .almoco-toggle label {
            font-weight: bold;
            color: #333;
            cursor: pointer;
        }
        
        .almoco-times {
            display: none;
            background-color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .almoco-times.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .almoco-description {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        /* Seção de Atendentes */
        .atendentes-section {
            background-color: white;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .atendentes-list {
            margin-top: 20px;
        }
        
        .atendente-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        
        .atendente-item h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        /* Seção de Serviços */
        .servicos-section {
            background-color: white;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .servicos-list {
            margin-top: 20px;
        }
        
        .servico-item {
            display: inline-block;
            background-color: #f8f9fa;
            padding: 8px 15px;
            margin: 0 10px 10px 0;
            border-radius: 4px;
        }
        
        .btn-editar {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .btn-editar:hover {
            background-color: #0b7dda;
        }
        
        .btn-remover {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 5px;
        }
        
        .btn-remover:hover {
            background-color: #d32f2f;
        }
        
        .btn-adicionar {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .btn-adicionar:hover {
            background-color: #45a049;
        }
        
        .input-servico {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            width: 300px;
        }

        /* Estilos para a nova seção de atendentes simplificada */
        .atendente-simple {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .atendente-simple-input {
            flex: 1;
        }

        .atendente-simple-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-adicionar-atendente {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-adicionar-atendente:hover {
            background-color: #45a049;
        }

        .btn-remover-atendente {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-remover-atendente:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <!-- Loader inicial -->
    <div class="loader-overlay" id="loaderOverlay">
        <div class="loader"></div>
    </div>

    <header>
        <div class="logo">PAINEL DE CONTROLE</div>
        <nav>
            <ul>
                <li><a href="painel.html" class="tab-link">CALENDÁRIO</a></li>
                <li><a href="painelconfig.html" class="tab-link active">CONFIGURAÇÕES</a></li>
                <li><a href="#" id="logoutBtn" class="logout-btn">SAIR</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <!-- Seção de Configuração de Horários -->
        <div class="horarios-config">
            <h3>CONFIGURAÇÃO DE HORÁRIOS DE ATENDIMENTO</h3>
            
            <form id="horariosForm">
                <div class="form-group">
                    <label>Dias de funcionamento:</label>
                    <div class="dias-semana" id="diasSemana">
                        <label class="dia-checkbox"><input type="checkbox" name="dia" value="1"> Segunda</label>
                        <label class="dia-checkbox"><input type="checkbox" name="dia" value="2"> Terça</label>
                        <label class="dia-checkbox"><input type="checkbox" name="dia" value="3"> Quarta</label>
                        <label class="dia-checkbox"><input type="checkbox" name="dia" value="4"> Quinta</label>
                        <label class="dia-checkbox"><input type="checkbox" name="dia" value="5"> Sexta</label>
                        <label class="dia-checkbox"><input type="checkbox" name="dia" value="6"> Sábado</label>
                        <label class="dia-checkbox"><input type="checkbox" name="dia" value="0"> Domingo</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Horário de funcionamento:</label>
                    <div class="horarios-container">
                        <div class="horario-input">
                            <label>Abertura</label>
                            <input type="time" id="horarioAbertura" required>
                        </div>
                        <div class="horario-input">
                            <label>Fechamento</label>
                            <input type="time" id="horarioFechamento" required>
                        </div>
                    </div>
                </div>
                
                <!-- Seção de almoço melhorada -->
                <div class="almoco-section">
                    <div class="almoco-toggle">
                        <input type="checkbox" id="temAlmoco">
                        <label for="temAlmoco">Definir horário de almoço</label>
                    </div>
                    
                    <p class="almoco-description">
                        Marque esta opção se seu estabelecimento fecha para almoço. Isso criará um intervalo no meio do dia onde não serão permitidos agendamentos.
                    </p>
                    
                    <div class="almoco-times" id="almocoTimes">
                        <div class="horarios-container">
                            <div class="horario-input">
                                <label>Início do almoço</label>
                                <input type="time" id="almocoInicio">
                            </div>
                            <div class="horario-input">
                                <label>Fim do almoço</label>
                                <input type="time" id="almocoFim">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="duracaoAtendimento">Duração de cada atendimento (minutos):</label>
                    <select id="duracaoAtendimento" required>
                        <option value="15">15 minutos</option>
                        <option value="30" selected>30 minutos</option>
                        <option value="45">45 minutos</option>
                        <option value="60">60 minutos</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="intervaloAtendimento">Intervalo entre atendimentos (minutos):</label>
                    <select id="intervaloAtendimento" required>
                        <option value="0">Sem intervalo</option>
                        <option value="5">5 minutos</option>
                        <option value="10">10 minutos</option>
                        <option value="15" selected>15 minutos</option>
                        <option value="20">20 minutos</option>
                        <option value="30">30 minutos</option>
                    </select>
                </div>

                <button type="submit" class="btn-salvar">Salvar Configurações</button>
                <div class="success-message" id="successMessage">Configurações salvas com sucesso!</div>
            </form>

            <div class="horarios-exemplo">
                <h4>Como funciona:</h4>
                <ul>
                    <li>Selecione os dias da semana em que seu estabelecimento está aberto</li>
                    <li>Defina o horário de abertura e fechamento</li>
                    <li>Marque a opção "Definir horário de almoço" se necessário</li>
                    <li>Escolha quanto tempo dura cada atendimento</li>
                    <li>Defina um intervalo entre os atendimentos (opcional)</li>
                </ul>
                <p>O sistema calculará automaticamente os horários disponíveis para agendamento.</p>
            </div>
        </div>

        <!-- Seção de Observação sobre Máquinas -->
<div class="horarios-config" style="margin-bottom: 30px;">
    <h3>INFORMAÇÕES SOBRE MÁQUINAS</h3>
    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 4px;">
        <p><strong>Observação:</strong> As máquinas adicionais que foram pedidas no cadastro terão seus LOGIN e SENHA criados e enviados para o e-mail cadastrado.</p>
    </div>
</div>

        <!-- Seção de Atendentes Simplificada -->
<div class="atendentes-section">
    <h3>GERENCIAR ATENDENTES E SERVIÇOS</h3>
    
    <div id="atendentesContainer">
        <!-- Os atendentes e serviços serão carregados aqui -->
    </div>
    
    <div style="margin-top: 20px;">
        <h4>Adicionar Novo Atendente</h4>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="novoAtendente" class="input-servico" placeholder="Nome do atendente">
            <select id="servicosAtendente" class="input-servico" multiple>
                <!-- Os serviços serão carregados aqui -->
            </select>
            <button id="btnAdicionarAtendente" class="btn-adicionar">
                <i class="fas fa-plus"></i> Adicionar
            </button>
        </div>
    </div>
    
    <button id="btnSalvarAtendentes" class="btn-salvar" style="margin-top: 20px;">
        Salvar Configurações
    </button>
</div>

        <!-- Seção de Serviços Disponíveis -->
        <div class="servicos-section">
            <h3>SERVIÇOS DISPONÍVEIS</h3>
            
            <p>Lista de serviços oferecidos pelo seu estabelecimento:</p>
            
            <div class="servicos-list" id="servicosList">
                <!-- Serviços serão listados aqui -->
            </div>
            
            <div style="margin-top: 20px;">
                <input type="text" id="novoServico" class="input-servico" placeholder="Digite um novo serviço">
                <button id="btnAdicionarServico" class="btn-adicionar">Adicionar Serviço</button>
            </div>
        </div>

        <!-- Seção de Relatório -->
        <div class="relatorio-section">
            <h3>SOLICITAR RELATÓRIO</h3>
            <p>Solicite um relatório completo dos seus agendamentos.</p>
            
            <form id="relatorioForm">
                <div class="form-group">
                    <label for="periodoRelatorio">Período do relatório:</label>
                    <select id="periodoRelatorio" required>
                        <option value="7">Últimos 7 dias</option>
                        <option value="15">Últimos 15 dias</option>
                        <option value="30" selected>Últimos 30 dias</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="180">Últimos 6 meses</option>
                        <option value="365">Últimos 12 meses</option>
                    </select>
                </div>
                
                <button type="submit" class="btn-salvar">Solicitar Relatório</button>
            </form>
            
            <div class="relatorio-info">
                <p><strong>Como funciona:</strong> Ao solicitar o relatório, nossa equipe irá preparar um arquivo com todos os dados dos seus agendamentos no período selecionado.</p>
                <p>O relatório será enviado para o e-mail cadastrado no prazo máximo de 24 horas.</p>
                <p>Para dúvidas ou solicitações específicas, (por favor, colocar no assunto do e-mail: CNPJ/CPF - RELATÓRIO - DATA XX/XX/XXXX A XX/XX/XXXX) entre em contato: <strong>suportehorario@gmail.com</strong></p>
            </div>
        </div>

        <!-- Informações Cadastrais -->
<div class="info-adicionais" id="userInfoContainer">
    <h2>INFORMAÇÕES CADASTRAIS</h2>
    <div id="userDataLoader" style="text-align: center;">Carregando dados...</div>
    
    <div class="info-contato">
        <p>Para alterar estas informações, entre em contato pelo e-mail: <strong>suportehorario@gmail.com</strong></p>
        <p>Inclua no assunto: "Alteração de Cadastro - [Seu CNPJ]"</p>
    </div>
    
    <button type="button" class="btn-cancelar">Cancelar Assinatura</button>
</div>

    <footer>
        <div class="contato-rodape">
            <p>Precisa de ajuda? Entre em contato conosco:</p>
            <p>E-mail: <a href="mailto:suportehorario@gmail.com">suportehorario@gmail.com</a> | Telefone: (62) 98159-6601</p>
            <p>Horário de atendimento: Segunda a Domingo, 24 horas</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAfk7tS6Z39uYyHnbKlwY1O1zeOx74LlQg",
            authDomain: "banco-de-dados-d253e.firebaseapp.com",
            projectId: "banco-de-dados-d253e",
            storageBucket: "banco-de-dados-d253e.appspot.com",
            messagingSenderId: "1005413315224",
            appId: "1:1005413315224:web:c87d1dd951785ed4f656ed"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Variável global para armazenar dados do usuário
        let currentUserData = null;
        let servicosDisponiveis = [];
        let atendentesData = [];
        
        // Verificação de autenticação e carregamento de dados
        document.addEventListener('DOMContentLoaded', function() {
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    // Usuário não autenticado, redireciona para login
                    window.location.href = 'https://horario.site/login.html';
                } else {
                    try {
                        // Busca os dados do usuário no Firestore
                        const userDoc = await db.collection('usuarios').where('email', '==', user.email).get();
                        
                        if (userDoc.empty) {
                            throw new Error('Dados do usuário não encontrados');
                        }
                        
                        // Pega o primeiro documento (deveria ter apenas um com o mesmo email)
                        const doc = userDoc.docs[0];
                        const userData = doc.data();
                        
                        // Adiciona o ID do documento aos dados do usuário
                        userData.id = doc.id;
                        currentUserData = userData;
                        
                        // Carrega os dados do usuário
                        loadUserData(userData);
                        loadHorariosConfig(userData);
                        loadAtendentesConfig(userData);
                        loadServicosConfig(userData);
                        document.getElementById('loaderOverlay').style.display = 'none';
                    } catch (error) {
                        console.error('Erro ao carregar dados do usuário:', error);
                        alert('Erro ao carregar dados do usuário. Por favor, faça login novamente.');
                        auth.signOut();
                        window.location.href = 'https://horario.site/login.html';
                    }
                }
            });
            
            // Toggle para mostrar/ocultar horário de almoço
            document.getElementById('temAlmoco').addEventListener('change', function() {
                const almocoTimes = document.getElementById('almocoTimes');
                if (this.checked) {
                    almocoTimes.classList.add('active');
                } else {
                    almocoTimes.classList.remove('active');
                }
            });
        });

        // Carrega os dados do usuário
        function loadUserData(userData) {
            try {
                displayUserData(userData);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados do usuário');
            }
        }

        // Carrega as configurações de horários do usuário
        async function loadHorariosConfig(userData) {
            try {
                if (userData.horariosConfig) {
                    loadHorariosData(userData.horariosConfig);
                } else {
                    // Tenta buscar do Firestore
                    const userDoc = await db.collection('usuarios').doc(userData.id).get();
                    if (userDoc.exists && userDoc.data().horariosConfig) {
                        loadHorariosData(userDoc.data().horariosConfig);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configurações de horários:', error);
            }
        }
        
        // Carrega as configurações de atendentes do usuário
async function loadAtendentesConfig(userData) {
    try {
        // Carrega os serviços primeiro
        if (userData.servicos) {
            servicosDisponiveis = userData.servicos.split('/').map(s => s.trim()).filter(s => s !== '');
            renderServicosSelect();
        }

        // Carrega os atendentes
        atendentesData = [];
        
        if (userData.nomeAtendente && userData.servicoAtendente) {
            // Converte para array se for string única
            if (typeof userData.nomeAtendente === 'string') {
                atendentesData.push({
                    nome: userData.nomeAtendente,
                    servicos: userData.servicoAtendente.split('/').map(s => s.trim()).filter(s => s !== '')
                });
            } else if (Array.isArray(userData.nomeAtendente)) {
                // Processa arrays de atendentes e serviços
                for (let i = 0; i < userData.nomeAtendente.length; i++) {
                    const servicos = Array.isArray(userData.servicoAtendente) ? 
                        (userData.servicoAtendente[i] || '').split('/').map(s => s.trim()).filter(s => s !== '') : 
                        (userData.servicoAtendente || '').split('/').map(s => s.trim()).filter(s => s !== '');
                    
                    atendentesData.push({
                        nome: userData.nomeAtendente[i],
                        servicos: servicos
                    });
                }
            }
        }
        
        // Se não encontrou atendentes, cria um padrão
        if (atendentesData.length === 0) {
            atendentesData.push({
                nome: "Atendente 1",
                servicos: []
            });
        }
        
        renderAtendentesList(atendentesData);
    } catch (error) {
        console.error('Erro ao carregar configurações de atendentes:', error);
    }
}

// Renderiza o select de serviços
function renderServicosSelect() {
    const select = document.getElementById('servicosAtendente');
    select.innerHTML = '';
    
    servicosDisponiveis.forEach(servico => {
        const option = document.createElement('option');
        option.value = servico;
        option.textContent = servico;
        select.appendChild(option);
    });
}

// Renderiza a lista de atendentes e serviços
function renderAtendentesList(atendentes) {
    const container = document.getElementById('atendentesContainer');
    container.innerHTML = '<h4>Atendentes Cadastrados</h4>';
    
    if (atendentes.length === 0) {
        container.innerHTML += '<p>Nenhum atendente cadastrado</p>';
        return;
    }
    
    atendentes.forEach((atendente, index) => {
        const atendenteDiv = document.createElement('div');
        atendenteDiv.className = 'atendente-item';
        
        atendenteDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${atendente.nome}</strong>
                    <p style="margin-top: 5px; color: #666;">
                        Serviços: ${atendente.servicos.join(', ')}
                    </p>
                </div>
                <div>
                    <button class="btn-editar" data-index="${index}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn-remover" data-index="${index}">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(atendenteDiv);
        
        // Adiciona event listeners
        atendenteDiv.querySelector('.btn-editar').addEventListener('click', () => editAtendente(index));
        atendenteDiv.querySelector('.btn-remover').addEventListener('click', () => removeAtendente(index));
    });
}

// Adiciona um novo atendente
async function addAtendente() {
    const nome = document.getElementById('novoAtendente').value.trim();
    const select = document.getElementById('servicosAtendente');
    const servicosSelecionados = Array.from(select.selectedOptions).map(opt => opt.value);
    
    if (!nome) {
        alert('Por favor, insira o nome do atendente');
        return;
    }
    
    if (servicosSelecionados.length === 0) {
        alert('Selecione pelo menos um serviço para o atendente');
        return;
    }
    
    atendentesData.push({
        nome: nome,
        servicos: servicosSelecionados
    });
    
    // Limpa os campos
    document.getElementById('novoAtendente').value = '';
    Array.from(select.options).forEach(opt => opt.selected = false);
    
    // Atualiza a lista
    renderAtendentesList(atendentesData);
}

// Edita um atendente existente
function editAtendente(index) {
    const atendente = atendentesData[index];
    const novoNome = prompt('Editar nome do atendente:', atendente.nome);
    
    if (novoNome === null) return;
    
    const nome = novoNome.trim();
    if (!nome) {
        alert('O nome não pode estar vazio');
        return;
    }
    
    // Mostra diálogo para editar serviços
    let servicosMsg = 'Serviços atuais:\n' + atendente.servicos.join('\n');
    servicosMsg += '\n\nDigite os novos serviços (separados por vírgula):';
    
    const novosServicos = prompt(servicosMsg, atendente.servicos.join(', '));
    if (novosServicos === null) return;
    
    const servicosArray = novosServicos.split(',').map(s => s.trim()).filter(s => s !== '');
    if (servicosArray.length === 0) {
        alert('O atendente deve ter pelo menos um serviço');
        return;
    }
    
    // Atualiza os dados
    atendentesData[index] = {
        nome: nome,
        servicos: servicosArray
    };
    
    renderAtendentesList(atendentesData);
}
        
        // Carrega as configurações de serviços do usuário
        async function loadServicosConfig(userData) {
            try {
                if (userData.servicos) {
                    // Divide os serviços pela barra "/"
                    servicosDisponiveis = userData.servicos.split('/').map(s => s.trim()).filter(s => s !== '');
                    renderServicosList(servicosDisponiveis);
                } else {
                    servicosDisponiveis = [];
                }
            } catch (error) {
                console.error('Erro ao carregar configurações de serviços:', error);
            }
        }

        // Preenche o formulário com os dados de horários
        function loadHorariosData(horariosData) {
            if (horariosData.diasFuncionamento) {
                horariosData.diasFuncionamento.forEach(dia => {
                    const checkbox = document.querySelector(`.dias-semana input[value="${dia}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            if (horariosData.horarioAbertura) {
                document.getElementById('horarioAbertura').value = horariosData.horarioAbertura;
            }
            
            if (horariosData.horarioFechamento) {
                document.getElementById('horarioFechamento').value = horariosData.horarioFechamento;
            }
            
            if (horariosData.almocoInicio && horariosData.almocoFim) {
                document.getElementById('temAlmoco').checked = true;
                document.getElementById('almocoTimes').classList.add('active');
                document.getElementById('almocoInicio').value = horariosData.almocoInicio;
                document.getElementById('almocoFim').value = horariosData.almocoFim;
            }
            
            if (horariosData.duracaoAtendimento) {
                document.getElementById('duracaoAtendimento').value = horariosData.duracaoAtendimento;
            }
            
            if (horariosData.intervaloAtendimento) {
                document.getElementById('intervaloAtendimento').value = horariosData.intervaloAtendimento;
            }
        }
        
        // Renderiza a lista de atendentes simplificada
        function renderAtendentesList(atendentes) {
            const container = document.getElementById('atendentesContainer');
            container.innerHTML = '';
            
            atendentes.forEach((atendente, index) => {
                const atendenteDiv = document.createElement('div');
                atendenteDiv.className = 'atendente-item';
                
                // Cria os inputs para nome e serviços
                const nomeAtendente = atendente.nome || `Atendente ${index + 1}`;
                const servicosAtendente = (atendente.servicos || []).join(' / ');
                
                atendenteDiv.innerHTML = `
                    <div class="atendente-simple">
                        <div class="atendente-simple-input">
                            <label>Nome do Atendente</label>
                            <input type="text" class="nome-atendente" value="${nomeAtendente}" data-index="${index}" placeholder="Nome do atendente">
                        </div>
                        <div class="atendente-simple-input">
                            <label>Serviço(s)</label>
                            <input type="text" class="servico-atendente" value="${servicosAtendente}" data-index="${index}" placeholder="Serviços (separados por /)">
                        </div>
                        <button class="btn-remover-atendente" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(atendenteDiv);
                
                // Adiciona event listener para o botão de remover
                atendenteDiv.querySelector('.btn-remover-atendente').addEventListener('click', function() {
                    removeAtendente(index);
                });
            });
        }
        
        // Remove um atendente da lista
        function removeAtendente(index) {
            if (atendentesData.length <= 1) {
                alert('Você deve ter pelo menos um atendente cadastrado');
                return;
            }
            
            if (confirm('Tem certeza que deseja remover este atendente?')) {
                atendentesData.splice(index, 1);
                renderAtendentesList(atendentesData);
            }
        }
        
        // Adiciona um novo atendente
        function addAtendente() {
            atendentesData.push({
                nome: `Atendente ${atendentesData.length + 1}`,
                servicos: []
            });
            renderAtendentesList(atendentesData);
        }
        
        // Salva todos os atendentes no Firebase
        async function saveAllAtendentes() {
            if (!currentUserData) return;
            
            try {
                // Atualiza os dados locais com os valores dos inputs
                const nomeInputs = document.querySelectorAll('.nome-atendente');
                const servicoInputs = document.querySelectorAll('.servico-atendente');
                
                atendentesData = [];
                
                nomeInputs.forEach((input, index) => {
                    const nome = input.value.trim();
                    const servicos = servicoInputs[index].value.trim().split('/').map(s => s.trim()).filter(s => s !== '');
                    
                    atendentesData.push({
                        nome: nome || `Atendente ${index + 1}`,
                        servicos: servicos
                    });
                });
                
                // Prepara os dados para salvar no Firestore
                const nomesAtendentes = atendentesData.map(a => a.nome);
                const servicosAtendentes = atendentesData.map(a => a.servicos.join(' / '));
                
                // Salva no Firestore
                await db.collection('usuarios').doc(currentUserData.id).set({
                    nomeAtendente: nomesAtendentes.length === 1 ? nomesAtendentes[0] : nomesAtendentes,
                    servicoAtendente: servicosAtendentes.length === 1 ? servicosAtendentes[0] : servicosAtendentes
                }, { merge: true });
                
                // Atualiza os dados locais
                currentUserData.nomeAtendente = nomesAtendentes.length === 1 ? nomesAtendentes[0] : nomesAtendentes;
                currentUserData.servicoAtendente = servicosAtendentes.length === 1 ? servicosAtendentes[0] : servicosAtendentes;
                
                alert('Atendentes atualizados com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar atendentes:', error);
                alert('Erro ao salvar atendentes. Tente novamente.');
            }
        }
        
        // Renderiza a lista de serviços
        function renderServicosList(servicos) {
            const container = document.getElementById('servicosList');
            container.innerHTML = '';
            
            servicos.forEach((servico, index) => {
                const servicoSpan = document.createElement('span');
                servicoSpan.className = 'servico-item';
                servicoSpan.innerHTML = `
                    ${servico}
                    <button class="btn-editar" data-index="${index}"><i class="fas fa-edit"></i></button>
                    <button class="btn-remover" data-index="${index}"><i class="fas fa-trash"></i></button>
                `;
                container.appendChild(servicoSpan);
            });
            
            // Adiciona event listeners aos botões
            document.querySelectorAll('.btn-editar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    editServico(index);
                });
            });
            
            document.querySelectorAll('.btn-remover').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    removeServico(index);
                });
            });
        }

        // Salva as configurações de horários no Firebase
        async function saveHorariosConfig(userData, config) {
            try {
                // Caminho específico para salvar as configurações
                const horariosRef = db.collection('usuarios').doc(userData.id);
                
                // Salva ou atualiza o documento
                await horariosRef.set({
                    horariosConfig: config
                }, { merge: true });
                
                // Mostra mensagem de sucesso
                const successMessage = document.getElementById('successMessage');
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                alert('Erro ao salvar configurações. Tente novamente.');
                return false;
            }
        }
        
        // Edita um serviço
        function editServico(index) {
            const novoNome = prompt('Editar serviço:', servicosDisponiveis[index]);
            
            if (novoNome !== null && novoNome.trim() !== '') {
                const servicoAtualizado = novoNome.trim();
                
                // Verifica se o novo nome já existe (ignorando o próprio item)
                if (servicosDisponiveis.some((s, i) => i !== index && s === servicoAtualizado)) {
                    alert('Este serviço já existe na lista');
                    return;
                }
                
                servicosDisponiveis[index] = servicoAtualizado;
                updateServicos(servicosDisponiveis);
            }
        }
        
        // Remove um serviço
        function removeServico(index) {
            if (confirm('Tem certeza que deseja remover este serviço?')) {
                servicosDisponiveis.splice(index, 1);
                updateServicos(servicosDisponiveis);
            }
        }
        
        // Adiciona um novo serviço
        async function addServico() {
            const novoServico = document.getElementById('novoServico').value.trim();
            
            if (!novoServico) {
                alert('Por favor, digite um nome para o serviço');
                return;
            }
            
            if (servicosDisponiveis.includes(novoServico)) {
                alert('Este serviço já está na lista');
                return;
            }
            
            servicosDisponiveis.push(novoServico);
            await updateServicos(servicosDisponiveis);
            
            // Limpa o campo de input
            document.getElementById('novoServico').value = '';
        }
        
        // Atualiza a lista de serviços no Firestore
        async function updateServicos(servicosArray) {
            try {
                const servicosString = servicosArray.join(' / ');
                
                await db.collection('usuarios').doc(currentUserData.id).set({
                    servicos: servicosString
                }, { merge: true });
                
                // Atualiza os dados locais
                currentUserData.servicos = servicosString;
                servicosDisponiveis = servicosArray;
                
                // Atualiza a exibição
                renderServicosList(servicosArray);
            } catch (error) {
                console.error('Erro ao atualizar serviços:', error);
                alert('Erro ao atualizar serviços. Tente novamente.');
            }
        }

        // Exibe os dados do usuário na página
        function displayUserData(userData) {
            const container = document.getElementById('userInfoContainer');
            
            // Remove o loader
            const loader = document.getElementById('userDataLoader');
            if (loader) loader.remove();
            
            // Preenche os dados do usuário
            container.innerHTML = `
                <h2>INFORMAÇÕES CADASTRAIS</h2>
                
                <div class="info-item">
                    <strong>Tipo de Pessoa</strong>
                    <div>${userData.tipoPessoa === 'pf' ? 'Pessoa Física' : 'Pessoa Jurídica' || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>${userData.tipoPessoa === 'pf' ? 'CPF' : 'CNPJ'}</strong>
                    <div>${userData.identificacao || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>Endereço</strong>
                    <div>${userData.endereco || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>Bairro/Setor</strong>
                    <div>${userData.bairro || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>Cidade</strong>
                    <div>${userData.cidade || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>Estado</strong>
                    <div>${userData.estado || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>CEP</strong>
                    <div>${userData.cep || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>Telefone/Celular</strong>
                    <div>${userData.telefone || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>E-mail</strong>
                    <div>${userData.email || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>${userData.tipoPessoa === 'pf' ? 'Nome Completo' : 'Nome Fantasia'}</strong>
                    <div>${userData.nomeFantasia || 'Não informado'}</div>
                </div>
                
                <div class="info-item">
                    <strong>Número de Máquinas em Uso</strong>
                    <div>${userData.maquinas || '0'}</div>
                </div>
                
                <div class="info-item">
                    <strong>Serviços Prestados</strong>
                    <div>${userData.servicos || 'Não informado'}</div>
                </div>
                
                <div class="info-contato">
                    <p>Para alterar estas informações, entre em contato pelo e-mail: <strong>suporte@horario.site</strong></p>
                    <p>Inclua no assunto: "Alteração de Cadastro - ${userData.identificacao || 'Seu CNPJ/CPF'}"</p>
                </div>
                
                <button type="button" class="btn-cancelar">Cancelar Assinatura</button>
            `;
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = 'https://horario.site/login.html';
            }).catch(error => {
                console.error('Erro ao fazer logout:', error);
            });
        });

        // Formulário de Configuração de Horários
        document.getElementById('horariosForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUserData) return;
            
            try {
                // Coletar dados do formulário
                const diasSelecionados = Array.from(document.querySelectorAll('.dias-semana input:checked')).map(el => el.value);
                const horarioAbertura = document.getElementById('horarioAbertura').value;
                const horarioFechamento = document.getElementById('horarioFechamento').value;
                const temAlmoco = document.getElementById('temAlmoco').checked;
                const almocoInicio = temAlmoco ? document.getElementById('almocoInicio').value : null;
                const almocoFim = temAlmoco ? document.getElementById('almocoFim').value : null;
                const duracaoAtendimento = document.getElementById('duracaoAtendimento').value;
                const intervaloAtendimento = document.getElementById('intervaloAtendimento').value;
                
                // Validação básica
                if (diasSelecionados.length === 0) {
                    alert('Selecione pelo menos um dia de funcionamento');
                    return;
                }
                
                if (!horarioAbertura || !horarioFechamento) {
                    alert('Preencha os horários de abertura e fechamento');
                    return;
                }
                
                if (temAlmoco && (!almocoInicio || !almocoFim)) {
                    alert('Preencha os horários de início e fim do almoço');
                    return;
                }
                
                // Criar objeto de configuração
                const config = {
                    diasFuncionamento: diasSelecionados,
                    horarioAbertura,
                    horarioFechamento,
                    duracaoAtendimento: parseInt(duracaoAtendimento),
                    intervaloAtendimento: parseInt(intervaloAtendimento),
                    ultimaAtualizacao: new Date().toISOString()
                };
                
                // Adiciona horário de almoço se necessário
                if (temAlmoco) {
                    config.almocoInicio = almocoInicio;
                    config.almocoFim = almocoFim;
                }
                
                // Salvar no Firebase
                await saveHorariosConfig(currentUserData, config);
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                alert('Erro ao salvar configurações. Tente novamente.');
            }
        });
        
        // Adiciona um novo atendente
        document.getElementById('btnAdicionarAtendente').addEventListener('click', addAtendente);
        
        // Salva todos os atendentes
        document.getElementById('btnSalvarAtendentes').addEventListener('click', saveAllAtendentes);
        
        // Adiciona um novo serviço
        document.getElementById('btnAdicionarServico').addEventListener('click', addServico);
        document.getElementById('novoServico').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addServico();
            }
        });
        
        // Formulário de Solicitação de Relatório
        document.getElementById('relatorioForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUserData) return;
            
            const periodo = document.getElementById('periodoRelatorio').value;
            
            // Mostra mensagem de sucesso
            alert(`Relatório solicitado com sucesso! Você receberá um e-mail com o relatório dos últimos ${periodo} dias em até 24 horas.`);
            
            // Aqui você pode adicionar lógica para enviar a solicitação para o backend
            // Por exemplo, criar um documento em uma coleção de solicitações de relatório
        });

        // Gerar credenciais para máquinas
        document.getElementById('btnGerarMaquinas').addEventListener('click', function() {
            const quantidade = parseInt(document.getElementById('quantidadeMaquinas').value);
            
            if (isNaN(quantidade) || quantidade < 1 || quantidade > 10) {
                alert('Por favor, insira um número válido de máquinas (1-10)');
                return;
            }
            
            // Simula a geração de credenciais
            const maquinasList = document.getElementById('maquinasList');
            maquinasList.innerHTML = '';
            
            for (let i = 1; i <= quantidade; i++) {
                const randomId = Math.random().toString(36).substring(2, 10);
                const randomPass = Math.random().toString(36).substring(2, 12);
                
                maquinasList.innerHTML += `
                    <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 4px;">
                        <strong>Máquina ${i}:</strong><br>
                        <span>Usuário: maquina_${randomId}</span><br>
                        <span>Senha: ${randomPass}</span>
                    </div>
                `;
            }
            
            document.getElementById('maquinasResult').style.display = 'block';
        });
    </script>
</body>
</html>
