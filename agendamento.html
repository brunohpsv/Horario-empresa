<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - HORÁRIO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        header {
            background: #000;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
        }
        .card-header {
            background: white;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            padding: 1.5rem;
        }
        .card-body {
            padding: 2rem;
        }
        .time-slot {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.75rem;
            width: 100%;
        }
        .time-slot:hover, .time-slot.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .time-slot.disabled {
            background: #f8f9fa;
            color: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #horarios-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        @media (max-width: 768px) {
            #horarios-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">HORÁRIO</div>
        <nav>
            <a href="https://horario.site" style="color: white; text-decoration: none;">Início</a>
        </nav>
    </header>

    <div class="container p-0">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" id="empresa-nome">Carregando...</h5>
                <small class="text-muted" id="empresa-servico"></small>
            </div>
            
            <div class="card-body">
                <div id="error-message" class="alert alert-danger" style="display:none"></div>
                
                <div id="formulario-agendamento">
                    <div class="mb-4">
                        <label class="form-label">CPF/CNPJ</label>
                        <input type="text" id="documento" class="form-control" placeholder="Digite seu CPF ou CNPJ" required>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3 mb-md-0" id="servico-group">
                            <label class="form-label">Serviço</label>
                            <select id="servico" class="form-select">
                                <option value="">Carregando serviços...</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="prestador-group" style="display:none">
                            <label class="form-label">Prestador</label>
                            <select id="prestador" class="form-select">
                                <option value="">Selecione um prestador</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Data</label>
                        <input type="text" id="calendar-input" class="form-control" placeholder="Selecione uma data">
                    </div>
                    
                    <div class="mb-4" id="horario-section" style="display:none">
                        <label class="form-label">Horários disponíveis para <span id="selected-date"></span></label>
                        <div id="horarios-container"></div>
                    </div>
                    
                    <div id="dados-section" style="display:none">
                        <h5 class="mb-4">Preencha seus dados</h5>
                        <div class="mb-4">
                            <label class="form-label">Nome Completo</label>
                            <input type="text" id="nome" class="form-control" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Telefone</label>
                            <input type="tel" id="telefone" class="form-control" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">E-mail (opcional)</label>
                            <input type="email" id="email" class="form-control">
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" id="btn-confirmar" style="display:none">Confirmar Agendamento</button>
                    </div>
                </div>
                
                <div id="resumo-agendamento" style="display:none">
                    <h4 class="mb-4">Agendamento confirmado!</h4>
                    <div class="mb-3">
                        <strong>Empresa:</strong> <span id="resumo-empresa"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Serviço:</strong> <span id="resumo-servico"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Prestador:</strong> <span id="resumo-prestador"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Data:</strong> <span id="resumo-data"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Horário:</strong> <span id="resumo-horario"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Cliente:</strong> <span id="resumo-cliente"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Contato:</strong> <span id="resumo-contato"></span>
                    </div>
                    
                    <div class="d-grid gap-3">
                        <button class="btn btn-primary btn-lg" onclick="window.print()">Imprimir</button>
                        <button class="btn btn-outline-secondary btn-lg" onclick="window.location.href='index.html'">Voltar ao Início</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAfk7tS6Z39uYyHnbKlwY1O1zeOx74LlQg",
            authDomain: "banco-de-dados-d253e.firebaseapp.com",
            projectId: "banco-de-dados-d253e",
            storageBucket: "banco-de-dados-d253e.appspot.com",
            messagingSenderId: "1005413315224",
            appId: "1:1005413315224:web:c87d1dd951785ed4f656ed"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Variáveis globais
        let empresaSelecionada = null;
        let servicoSelecionado = null;
        let prestadorSelecionado = null;
        let dataSelecionada = null;
        let horarioSelecionado = null;
        let documentoCliente = null;
        
        // Configurações de horários padrão
        const horariosConfig = {
            duracaoAtendimento: 30,
            horarioAbertura: "08:00",
            horarioFechamento: "18:00",
            intervaloAtendimento: 15
        };
        
        // Inicializa o calendário
        const calendar = flatpickr("#calendar-input", {
            locale: "pt",
            minDate: "today",
            dateFormat: "d/m/Y",
            disable: [date => date.getDay() === 0 || date.getDay() === 6],
            onChange: (selectedDates) => {
                dataSelecionada = selectedDates[0];
                document.getElementById('selected-date').textContent = formatarData(dataSelecionada);
                carregarHorariosDisponiveis();
            }
        });
        
        // Funções auxiliares
        function formatarData(date) {
            return new Date(date).toLocaleDateString('pt-BR');
        }
        
        function formatarDataFirestore(date) {
            return new Date(date).toISOString().split('T')[0];
        }
        
        function mostrarErro(mensagem) {
            const el = document.getElementById('error-message');
            el.textContent = mensagem;
            el.style.display = 'block';
        }
        
        // Funções principais
        function carregarDadosEmpresa() {
            const empresaId = new URLSearchParams(window.location.search).get('id');
            
            if (!empresaId) {
                mostrarErro("Nenhuma empresa selecionada.");
                return;
            }
            
            db.collection("usuarios").doc(empresaId).get()
                .then(doc => {
                    if (!doc.exists) {
                        mostrarErro("Empresa não encontrada.");
                        return;
                    }
                    
                    empresaSelecionada = { id: doc.id, ...doc.data() };
                    document.getElementById('empresa-nome').textContent = empresaSelecionada.nomeFantasia || "Empresa";
                    
                    // Carrega os serviços
                    carregarServicos();
                })
                .catch(err => {
                    console.error("Erro ao carregar empresa:", err);
                    mostrarErro("Erro ao carregar dados da empresa.");
                });
        }
        
        function carregarServicos() {
            if (!empresaSelecionada) return;
            
            const servicoSelect = document.getElementById('servico');
            servicoSelect.innerHTML = '<option value="">Selecione um serviço</option>';
            
            // Verifica se a empresa tem serviços definidos
            if (empresaSelecionada.servico) {
                let servicos = [];
                
                if (typeof empresaSelecionada.servico === 'string') {
                    servicos = empresaSelecionada.servico.split('\n')
                        .map(s => s.trim())
                        .filter(s => s.length > 0);
                } else if (Array.isArray(empresaSelecionada.servico)) {
                    servicos = empresaSelecionada.servico;
                }
                
                servicos.forEach(servico => {
                    const option = document.createElement('option');
                    option.value = servico;
                    option.textContent = servico;
                    servicoSelect.appendChild(option);
                });
                
                // Event listener para seleção de serviço
                servicoSelect.addEventListener('change', function() {
                    servicoSelecionado = this.value;
                    if (dataSelecionada) carregarHorariosDisponiveis();
                });
            } else {
                mostrarErro("Esta empresa não possui serviços cadastrados.");
            }
        }
        
        function calcularHorariosDisponiveis() {
            const horarios = [];
            const [hAbertura, mAbertura] = horariosConfig.horarioAbertura.split(':').map(Number);
            const [hFechamento, mFechamento] = horariosConfig.horarioFechamento.split(':').map(Number);
            
            const inicio = hAbertura * 60 + mAbertura;
            const fim = hFechamento * 60 + mFechamento;
            const intervalo = horariosConfig.intervaloAtendimento;
            
            for (let minutos = inicio; minutos + horariosConfig.duracaoAtendimento <= fim; minutos += intervalo) {
                const horas = Math.floor(minutos / 60);
                const mins = minutos % 60;
                horarios.push(`${String(horas).padStart(2, '0')}:${String(mins).padStart(2, '0')}`);
            }
            
            return horarios;
        }
        
        function carregarHorariosDisponiveis() {
            if (!empresaSelecionada || !dataSelecionada || !servicoSelecionado) return;
            
            const container = document.getElementById('horarios-container');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-3">Carregando...</p></div>';
            
            document.getElementById('horario-section').style.display = 'block';
            document.getElementById('dados-section').style.display = 'none';
            document.getElementById('btn-confirmar').style.display = 'none';
            
            // Simulação de carregamento - na prática, você consultaria o banco de dados
            setTimeout(() => {
                const horarios = calcularHorariosDisponiveis();
                exibirHorariosDisponiveis(horarios);
            }, 500);
        }
        
        function exibirHorariosDisponiveis(horarios) {
            const container = document.getElementById('horarios-container');
            container.innerHTML = '';
            
            if (horarios.length === 0) {
                container.innerHTML = '<div class="alert alert-danger">Nenhum horário disponível.</div>';
                return;
            }
            
            horarios.forEach(horario => {
                const btn = document.createElement('button');
                btn.className = 'time-slot';
                btn.textContent = horario;
                
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.time-slot').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    horarioSelecionado = horario;
                    document.getElementById('dados-section').style.display = 'block';
                    document.getElementById('btn-confirmar').style.display = 'block';
                });
                
                container.appendChild(btn);
            });
        }
        
        function confirmarAgendamento() {
            const nome = document.getElementById('nome').value.trim();
            const telefone = document.getElementById('telefone').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!nome || !telefone) {
                mostrarErro("Preencha todos os campos obrigatórios.");
                return;
            }
            
            // Preenche o resumo
            document.getElementById('resumo-empresa').textContent = empresaSelecionada.nomeFantasia || "Empresa";
            document.getElementById('resumo-servico').textContent = servicoSelecionado;
            document.getElementById('resumo-prestador').textContent = prestadorSelecionado || "Não especificado";
            document.getElementById('resumo-data').textContent = formatarData(dataSelecionada);
            document.getElementById('resumo-horario').textContent = horarioSelecionado;
            document.getElementById('resumo-cliente').textContent = nome;
            document.getElementById('resumo-contato').textContent = telefone + (email ? ` (${email})` : '');
            
            // Mostra o resumo e esconde o formulário
            document.getElementById('formulario-agendamento').style.display = 'none';
            document.getElementById('resumo-agendamento').style.display = 'block';
            
            // Aqui você normalmente enviaria os dados para o Firebase
            console.log("Agendamento confirmado:", {
                servico: servicoSelecionado,
                data: formatarDataFirestore(dataSelecionada),
                horario: horarioSelecionado,
                clienteNome: nome,
                clienteTelefone: telefone,
                clienteEmail: email
            });
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            carregarDadosEmpresa();
            
            document.getElementById('btn-confirmar').addEventListener('click', confirmarAgendamento);
            
            // Máscara para CPF/CNPJ
            document.getElementById('documento').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                } else {
                    value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                }
                e.target.value = value;
                documentoCliente = value;
            });
            
            // Máscara para telefone
            document.getElementById('telefone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                e.target.value = value.substring(0, 15);
            });
        });
    </script>
</body>
</html>
